<!DOCTYPE html><html class="theme-next gemini" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="//cloud.ovvow.com/static/js/pace/pace.min.js"></script><link rel="stylesheet" href="//cloud.ovvow.com/static/js/pace/pace-theme-mac-osx.min.css"><meta name="baidu-site-verification" content="kyfztVzWNL"><link rel="stylesheet" href="//cloud.ovvow.com/static/js/fancybox/source/jquery.fancybox.css"><link rel="stylesheet" href="//cloud.ovvow.com/static/js/font-awesome/css/font-awesome.css"><link rel="stylesheet" href="/css/main.css?v=7.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0"><link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"7.2.0",sidebar:{position:"left",display:"post",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!0,fancybox:!0,fastclick:!1,lazyload:!0,tabs:!0,motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><script>!function(e,t,o,a,c,i,n){e.DaoVoiceObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=+new Date,i=t.createElement(o),n=t.getElementsByTagName(o)[0],i.async=1,i.src=a,i.charset="utf-8",n.parentNode.insertBefore(i,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"af2264da"}),daovoice("update")</script><meta name="description" content="本篇博客主要讲解了java虚拟机的内存区域"><meta name="keywords" content="java"><meta property="og:type" content="article"><meta property="og:title" content="java虚拟机内存详解"><meta property="og:url" content="https://guopengd.github.io/posts/java-virtual-machine-one/index.html"><meta property="og:site_name" content="何处有所栖"><meta property="og:description" content="本篇博客主要讲解了java虚拟机的内存区域"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cloud.ovvow.com/static/images/c%2B%2B%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86.gif"><meta property="og:image" content="https://cloud.ovvow.com/static/images/java%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86.gif"><meta property="og:image" content="https://cloud.ovvow.com/static/images/java%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.png"><meta property="og:updated_time" content="2020-11-24T11:58:28.234Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="java虚拟机内存详解"><meta name="twitter:description" content="本篇博客主要讲解了java虚拟机的内存区域"><meta name="twitter:image" content="https://cloud.ovvow.com/static/images/c%2B%2B%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86.gif"><link rel="alternate" href="/atom.xml" title="何处有所栖" type="application/atom+xml"><link rel="canonical" href="https://guopengd.github.io/posts/java-virtual-machine-one/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>java虚拟机内存详解 | 何处有所栖</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?8e77efaabd18ab3f9d6b08b3b40816d0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">何处有所栖</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">君子不立危墙之下</h1></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-photos"><a href="/photos/" rel="section"><i class="menu-item-icon fa fa-fw fa-image"></i><br>图库</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><a href="https://github.com/guopengd" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://guopengd.github.io/posts/java-virtual-machine-one/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="何处有所栖"><meta itemprop="description" content="想到什么写点什么，偶尔中二，偶尔哲学。"><meta itemprop="image" content="//cloud.ovvow.com/static/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="何处有所栖"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">java虚拟机内存详解</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-06-11 15:44:10" itemprop="dateCreated datePublished" datetime="2020-06-11T15:44:10+08:00">2020-06-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span></span><br></div></header><div class="post-body" itemprop="articleBody"><p>本篇博客主要讲解了java虚拟机的内存区域</p><a id="more"></a><h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h3><p>在正篇开始前，我们先来看看两张图：<br><img src="https://cloud.ovvow.com/static/images/c%2B%2B%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86.gif" alt="C++垃圾收集机制"><br><img src="https://cloud.ovvow.com/static/images/java%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86.gif" alt="java垃圾收集机制"><br>相信以上两张图大家都看过吧，对于C/C++程序员来说，每一个对象在创建的时候都需要自己手动去写 delete/free 操作来释放内存(如图一，是不是很形象)，虽然这样可以保证每一个对象都被正确的释放内存，避免内存溢出和内存泄漏的问题。但是，这是一个相当耗费精气神的事情，有时自己因为疏忽未释放对象导致产生问题。java 则和C/C++不同，程序员把内存控制权利交给 Java 虚拟机，然而，虚拟机不是万能的，如果我们不了解虚拟机内存状态，一旦出现内存泄漏和溢出方面的问题，那么排查错误是非常困难的(如图二，工具不是万能的)。</p><h3 id="2-java虚拟机运行时数据库"><a href="#2-java虚拟机运行时数据库" class="headerlink" title="2. java虚拟机运行时数据库"></a>2. java虚拟机运行时数据库</h3><p>java虚拟机在执行java程序的过程中会把它所管理的内存划分为若干个不同的数据区域，以下是根据《java虚拟机规范(SE 7版)》的规定下，java内存区域的划分。<br><img src="https://cloud.ovvow.com/static/images/java%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.png" alt="JVM内存模型"></p><h4 id="2-1-程序计数器"><a href="#2-1-程序计数器" class="headerlink" title="2.1 程序计数器"></a>2.1 程序计数器</h4><p>程序计数器(Program Counter Register)是一块极小的内存空间，他可以看做是当前线程所执行的字节码的行号指示器。在虚拟机的概念模型中，字节码解释器工作时就是通过改变这个计数器的值开选取下一条需要执行的字节码指令，分支、循环、跳转、异常处理、线程恢复等基础功能都需要依赖这个计数器完成。</p><p>因为现在一个处理器（多核处理器来说是一个内核）只会执行一条程序指令，为了线程切换后能恢复到正确的执行位置，每条线程都有一个独立的程序计数器，各个线程之间计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存。</p><p><font color="red">注意：程序计数器是唯一一个不会出现OutOfMemoryError的内存区域。</font></p><h4 id="2-2-java虚拟机栈"><a href="#2-2-java虚拟机栈" class="headerlink" title="2.2 java虚拟机栈"></a>2.2 java虚拟机栈</h4><p>java虚拟机栈（Java Virtual Machine Stacks）也是线程私有的，它的生命周期与线程相同，虚拟机栈描述的是java方法执行的内存模型，每个方法在执行的时候会创建一个<b>栈帧</b>来存储局部变量表、操作数栈、动态链接、方法出入口等信息，每一个方法的执行到结束，实际都是一个栈帧在虚拟机栈中入栈到出栈的过程。</p><ol><li><p>局部变量表：局部变量表存放了编译期可知的各种基本数据类型(boolean、byte、char、short、int、float、long、double)、对象引用(reference类型，它并不等同于对象，可能是一个指向对象起始地址的指针，也可能是指向一个代表对象的句柄或者其他与此对象相关的位置)和returnAddress类型(指向了一条字节码指令的地址)。</p></li><li><p>操作数栈：操作数栈(Operand Stack)也常称为操作栈，它是一个后入先出栈(LIFO)。同局部变量表一样，操作数栈的最大深度也在编译的时候写入到方法的Code属性的max_stacks数据项中。操作数栈的每一个元素可以是任意Java数据类型，32位的数据类型占一个栈容量，64位的数据类型占2个栈容量,且在方法执行的任意时刻，操作数栈的深度都不会超过max_stacks中设置的最大值。当一个方法刚刚开始执行时，其操作数栈是空的，随着方法执行和字节码指令的执行，会从局部变量表或对象实例的字段中复制常量或变量写入到操作数栈，再随着计算的进行将栈中元素出栈到局部变量表或者返回给方法调用者，也就是出栈/入栈操作。一个完整的方法执行期间往往包含多个这样出栈/入栈的过程。有关操作数栈的详细指令可参考：<a href="https://emacsist.github.io/2017/06/19/jvm%E5%AD%97%E8%8A%82%E7%A0%81%E5%AD%A6%E4%B9%A0%E4%B8%8E%E7%90%86%E8%A7%A3/" target="_blank" rel="noopener">jvm字节码学习与理解</a></p></li><li><p>动态连接：在一个class文件中，一个方法要调用其他方法，需要将这些方法的符号引用转化为其在内存地址中的直接引用，而符号引用存在于方法区中的运行时常量池。Java虚拟机栈中，每个栈帧都包含一个指向运行时常量池中该栈所属方法的符号引用，持有这个引用的目的是为了支持方法调用过程中的动态连接(Dynamic Linking)。 这些符号引用一部分会在类加载阶段或者第一次使用时就直接转化为直接引用，这类转化称为静态解析。另一部分将在每次运行期间转化为直接引用，这类转化称为动态连接。</p></li><li><p>方法返回：在方法正常完成退出或者异常完成退出后都需要返回到方法被调用的位置，程序才能继续执行。方法返回时可能需要在当前栈帧中保存一些信息，用来帮他恢复它的上层方法执行状态。当方法正常完成退出时，调用者的PC计数值可以作为返回地址，栈帧中可能保存此计数值。而方法异常退出时，返回地址是通过异常处理器表确定的，栈帧中一般不会保存此部分信息。</p></li></ol><p>Java 虚拟机栈会出现两种异常：StackOverFlowError 和 OutOfMemoryError。</p><ul><li>StackOverFlowError： 若Java虚拟机栈的内存大小不允许动态扩展(大部分虚拟机都可动态拓展，只是Java虚拟机规范中允许固定长度的虚拟机栈)，那么当线程请求栈的深度超过当前Java虚拟机栈的最大深度的时候，就抛出StackOverFlowError异常。</li><li>OutOfMemoryError： 若 Java 虚拟机栈的内存大小允许动态扩展，且当线程请求栈时内存用完了，无法再动态扩展了，此时抛出OutOfMemoryError异常。</li></ul><p><font color="red">注意：在32位虚拟机上，long和double占用了2个word，因此对于long和double的操作是非原子性的，在64位虚拟机上，long和double的操作是原子性的，为了程序的可移植性，最好在涉及原子操作时使用volatile保障其原子性</font></p><h4 id="2-3-java堆"><a href="#2-3-java堆" class="headerlink" title="2.3 java堆"></a>2.3 java堆</h4><p>Java堆（Heap）是虚拟机所管理的内存中最大的一块，Java 堆是所有线程共享的一块内存区域，在虚拟机启动时创建。此内存区域的唯一目的就是存放对象实例，几乎所有的对象实例以及数组都在这里分配内存。</p><p>Java 堆是垃圾收集器管理的主要区域，因此也被称作GC堆（Garbage Collected Heap）.从垃圾回收的角度，由于现在收集器基本都采用分代垃圾收集算法，所以Java堆还可以细分为：新生代和老年代：在细致一点有：Eden空间、From Survivor、To Survivor空间等。进一步划分的目的是更好地回收内存，或者更快地分配内存。</p><p>Java堆在没有内存完成实例分配，并且堆也无法再拓展的时候，会抛出OutOfMemoryError。</p><h4 id="2-4-方法区"><a href="#2-4-方法区" class="headerlink" title="2.4 方法区"></a>2.4 方法区</h4><p>方法区（Method Area）与 Java 堆一样，是各个线程共享的内存区域，它用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。虽然Java虚拟机规范把方法区描述为堆的一个逻辑部分，但是它却有一个别名叫做 Non-Heap（非堆），目的应该是与 Java 堆区分开来。相对而言，垃圾收集行为在这个区域是比较少出现的，但并非数据进入方法区后就“永久存在”了。</p><p>HotSpot 虚拟机中方法区也常被称为 “永久代”，本质上两者并不等价。仅仅是因为 HotSpot 虚拟机设计团队用永久代来实现方法区而已，这样 HotSpot 虚拟机的垃圾收集器就可以像管理 Java 堆一样管理这部分内存了。但是这并不是一个好主意，因为这样更容易遇到内存溢出(OutOfMemoryError)问题。最典型的场景就是，在 jsp 页面比较多的情况，容易出现永久代内存溢出。</p><p><font color="red">注意：我们要区分开JMM（java内存模型）和JVM虚拟机的区别，JMM定义了是 JVM 的规范，而后者则是 JVM 规范的一种实现，在 JDK 1.8中移除整个永久代，取而代之的是一个叫元空间（Metaspace）的区域（永久代使用的是JVM的堆内存空间，而元空间使用的是物理内存，直接受到本机的物理内存限制）。</font></p><h4 id="2-5-运行时常量池"><a href="#2-5-运行时常量池" class="headerlink" title="2.5 运行时常量池"></a>2.5 运行时常量池</h4><p>运行时常量池（Runtime Constant Pool）是方法区的一部分。Class 文件中除了有类的版本、字段、方法、接口等描述信息外，还有常量池信息（用于存放编译期生成的各种字面量和符号引用）。既然运行时常量池时方法区的一部分，自然受到方法区内存的限制，当常量池无法再申请到内存时会抛出 OutOfMemoryError 异常。</p><p><font color="red">注意：为了方便JDK1.8中永久代向元空间转变，在JDK1.7及之后版本的 JVM 已经将运行时常量池从方法区中移了出来，在 Java 堆（Heap）中开辟了一块区域存放运行时常量池。</font></p><h4 id="2-6-直接内存"><a href="#2-6-直接内存" class="headerlink" title="2.6 直接内存"></a>2.6 直接内存</h4><p>直接内存（Direct Memory）并不是虚拟机运行时数据区的一部分，也不是虚拟机规范中定义的内存区域，但是这部分内存也被频繁地使用。而且也可能导致OutOfMemoryError异常出现。</p><p>JDK1.4中新加入的 NIO(New Input/Output) 类，引入了一种基于通道（Channel） 与缓存区（Buffer） 的 I/O 方式，它可以直接使用Native函数库直接分配堆外内存，然后通过一个存储在 Java 堆中的 DirectByteBuffer 对象作为这块内存的引用进行操作。这样就能在一些场景中显著提高性能，因为避免了在 Java 堆和 Native 堆之间来回复制数据。虽然本机直接内存的分配不会受到 Java 堆的限制，但是，既然是内存就会受到本机总内存大小以及处理器寻址空间的限制。</p><h3 id="3-有关字符串的补充"><a href="#3-有关字符串的补充" class="headerlink" title="3. 有关字符串的补充"></a>3. 有关字符串的补充</h3><h4 id="3-1-String对象的创建："><a href="#3-1-String对象的创建：" class="headerlink" title="3.1 String对象的创建："></a>3.1 String对象的创建：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String a = <span class="string">"abc"</span>;</span><br><span class="line">    String b = <span class="keyword">new</span> String(<span class="string">"abc"</span>);</span><br><span class="line">    System.out.println(a == b); <span class="comment">// false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在图上例子中，a = “abc” 会首先在常量池中查找是否存在该字符串，如果存在则a直接指向常量池中的 “abc”；如果不存在，则在常量池中创建 “abc” ,之后将a指向该字符串。 b = new String(“abc”) 则是通过 new 关键字，直接在堆内分配内存创建 “abc”，之后再将 b 指向该字符串。另外，只要是通过 new 创建的对象，都是直接在堆内分配内存。因此，a == b 的结果是false，因为一个指向的是常量池中的字符串，一个指向的是堆中的字符串。</p><h4 id="3-2-String-intern"><a href="#3-2-String-intern" class="headerlink" title="3.2 String.intern()"></a>3.2 String.intern()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String str1 = <span class="keyword">new</span> StringBuilder(<span class="string">"计算机"</span>).append(<span class="string">"软件"</span>).toString();</span><br><span class="line">    System.out.println(str1.intern() == str1);</span><br><span class="line">    String str2 = <span class="keyword">new</span> StringBuilder(<span class="string">"ja"</span>).append(<span class="string">"va"</span>).toString();</span><br><span class="line">    System.out.println(str2.intern() == str2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码在JDK1.6中，会得到两个false，而在JDK1.7中，会得到一个true和一个false。产生差异的原因是：在JDK1.6中，intern() 方法会把首次遇到的字符串实例复制到永久代中(即永久代中的字符串常量池中)，返回的也是永久代中这个字符串实例的引用。而StringBuilder创建的字符串实例在java堆上，所以必然不是一个引用，因此都返回false。</p><p>而在JDK1.7中的 intern() 不会再复制实例，只是在常量池中记录首次出现的实例医用，因此 intern() 返回的引用和由StringBuilder创建的那个字符串是同一个实例。对str2比较返回false的原因是因为“java”这个字符串在执行StringBuilder.toString()就出现过了(注：java在虚拟机启动的时候内部初始化并使用过)，所以字符串常量池中已经有了它的引用，不符合“首次出现”的原则。而“计算机软件”这个字符串则是首次出现，因此返回true。</p><h4 id="3-2-有关字符串相加编译器的优化"><a href="#3-2-有关字符串相加编译器的优化" class="headerlink" title="3.2 有关字符串相加编译器的优化"></a>3.2 有关字符串相加编译器的优化</h4><p><font color="red">前景提要：本代码的编译环境为JDK1.8，用到了上一节 String.intern() 的知识点</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String sbBc = <span class="keyword">new</span> StringBuilder(<span class="string">"b"</span>).append(<span class="string">"c"</span>).toString();</span><br><span class="line">    String str1 = <span class="string">"a"</span> + <span class="string">"bc"</span>;</span><br><span class="line">    String str2 = <span class="string">"abc"</span>;</span><br><span class="line">    <span class="comment">// System.out.println(sbBc.intern() == sbBc); // true</span></span><br><span class="line">    String str3 = str1 + <span class="string">"b"</span> + <span class="string">"c"</span>;</span><br><span class="line">    System.out.println(str1 == str2); <span class="comment">// true</span></span><br><span class="line">    System.out.println(str2 == str3); <span class="comment">// false</span></span><br><span class="line">    <span class="comment">// System.out.println(sbBc.intern() == sbBc); // false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译器在进行编译的时候会有一些优化操作，例如从”str1 == str2” 的输出是true的情况中我们可以看出，编译器在两个常量直接相加的时候，会直接将常量编译成一个整体，即将 “a” + “bc” 直接编译成 “abc”。 因此，str1 == str2 输出为 true。为了验证我们可以把第四行被注释的输出语句放开，我们会发现他的结果是true，这说明在str1的赋值中，是没有生成 “bc” 这个常量的，而是直接编译成了 “abc”。</p><p>而在有变量的情况下，编译器无法识别变量 a, 但是编译器依然会将其优化成 StringBuild.append() 进行相加之后调用 toString() 方法。并且，编译器还能智能的识别到”b” + “c”这个可以直接编译成 “bc”，因此在 append() 调用的时候，编译器会直接优化成 append(“bc”) 而不是append(“b”).append(“c”) ,验证的时候，我们只需要注释掉第一个打印输出，放开最后一个打印输出，你会发现最终输出的结果是false，这能够证明 “bc” 常量是在优化成 append(“bc”) 的时候生成在常量池中的。</p><p>当然，我还会从java编译后的字节码中进一步验证这个知识点，上述代码生成的字节码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       0: new           #2                  // class java/lang/StringBuilder</span><br><span class="line">       <span class="number">3</span>: dup</span><br><span class="line">       4: ldc           #3                  // String b</span><br><span class="line">       6: invokespecial #4                  // Method java/lang/StringBuilder."&lt;init&gt;":(Ljava/lang/String;)V</span><br><span class="line">       9: ldc           #5                  // String c</span><br><span class="line">      11: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">      14: invokevirtual #7                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span><br><span class="line">      <span class="number">17</span>: astore_1</span><br><span class="line">      18: ldc           #8                  // String abc</span><br><span class="line">      <span class="number">20</span>: astore_2</span><br><span class="line">      21: ldc           #8                  // String abc</span><br><span class="line">      <span class="number">23</span>: astore_3</span><br><span class="line">      24: new           #2                  // class java/lang/StringBuilder</span><br><span class="line">      <span class="number">27</span>: dup</span><br><span class="line">      28: invokespecial #9                  // Method java/lang/StringBuilder."&lt;init&gt;":()V</span><br><span class="line">      <span class="number">31</span>: aload_2</span><br><span class="line">      32: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">      35: ldc           #10                 // String bc</span><br><span class="line">      37: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">      40: invokevirtual #7                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span><br><span class="line">      <span class="number">43</span>: astore        <span class="number">4</span></span><br><span class="line">      45: getstatic     #11                 // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      <span class="number">48</span>: aload_1</span><br><span class="line">      49: invokevirtual #12                 // Method java/lang/String.intern:()Ljava/lang/String;</span><br><span class="line">      <span class="number">52</span>: aload_1</span><br><span class="line">      <span class="number">53</span>: if_acmpne     <span class="number">60</span></span><br><span class="line">      <span class="number">56</span>: iconst_1</span><br><span class="line">      <span class="number">57</span>: goto          <span class="number">61</span></span><br><span class="line">      <span class="number">60</span>: iconst_0</span><br><span class="line">      61: invokevirtual #13                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">      64: getstatic     #11                 // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      <span class="number">67</span>: aload_2</span><br><span class="line">      <span class="number">68</span>: aload_3</span><br><span class="line">      <span class="number">69</span>: if_acmpne     <span class="number">76</span></span><br><span class="line">      <span class="number">72</span>: iconst_1</span><br><span class="line">      <span class="number">73</span>: goto          <span class="number">77</span></span><br><span class="line">      <span class="number">76</span>: iconst_0</span><br><span class="line">      77: invokevirtual #13                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">      80: getstatic     #11                 // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      <span class="number">83</span>: aload_3</span><br><span class="line">      <span class="number">84</span>: aload         <span class="number">4</span></span><br><span class="line">      <span class="number">86</span>: if_acmpne     <span class="number">93</span></span><br><span class="line">      <span class="number">89</span>: iconst_1</span><br><span class="line">      <span class="number">90</span>: goto          <span class="number">94</span></span><br><span class="line">      <span class="number">93</span>: iconst_0</span><br><span class="line">      94: invokevirtual #13                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">      <span class="number">97</span>: <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>字节码我就不解释了，大家有兴趣可以看参考这个网站：<a href="https://emacsist.github.io/2017/06/19/jvm%E5%AD%97%E8%8A%82%E7%A0%81%E5%AD%A6%E4%B9%A0%E4%B8%8E%E7%90%86%E8%A7%A3/" target="_blank" rel="noopener">jvm字节码学习与理解</a>。字节码对应的java代码解释如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>-<span class="number">6</span>：String sbBc = <span class="keyword">new</span> StringBuilder(<span class="string">"b"</span>)</span><br><span class="line"><span class="number">9</span>-<span class="number">11</span>：sbBc.append(<span class="string">"c"</span>)</span><br><span class="line"><span class="number">14</span>: sbBc.toString() <span class="comment">// 至此，整体对应为：String sbBc = new StringBuilder("b").append("c").toString()。</span></span><br><span class="line"><span class="number">17</span>-<span class="number">18</span> String str1 = <span class="string">"abc"</span></span><br><span class="line"><span class="number">20</span>-<span class="number">21</span> String str2 = <span class="string">"abc"</span></span><br><span class="line"><span class="number">23</span>-<span class="number">28</span> String str3 = <span class="keyword">new</span> StringBuilder() </span><br><span class="line"><span class="number">31</span>-<span class="number">32</span> str3.append(a)</span><br><span class="line"><span class="number">35</span> 将bc入栈放入常量池</span><br><span class="line"><span class="number">37</span> str3.append(<span class="string">"bc"</span>)</span><br><span class="line"><span class="number">40</span> str3.toString()</span><br></pre></td></tr></table></figure><p>在 17-18 和 20-21 中我们可以发现str1和str2生成的字节码完全一样，证明了编译器的第一点优化。而 23-40 所对应的字节码我们可以发现，编译器加字符串相加优化成了StringBuilder的 append() 调用，同时编译器还将将后面的 “b” + “c” 优化成了 “bc”。</p><h3 id="4-来点哲学？"><a href="#4-来点哲学？" class="headerlink" title="4 来点哲学？"></a>4 来点哲学？</h3><p>最近空间看到一条说说：“有的人没有得到什么，却希望别人能够得到；有的人没有得到什么，却希望别人也得不到。”看完之后，还是有点感触的。我向来都是支持人性本恶的观点，一切的“善”不过是一种道德思维以及修养的学习与提升。因为恶往往是与生俱来对自我的放纵，所以我们要学做人，学处事之道。而此道并无终点，有些人总是徘徊在原点嘲笑别人无止境的前行，企图将别人和自己捆绑在“地狱”之中。这和学生时期不肯学习的人嘲笑别人学习竟如出一辙，或许是同一批人长大了吧。</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/java/" rel="tag"><i class="fa fa-tag"></i> java</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/book-recommend/" rel="next" title="java学习书籍推荐"><i class="fa fa-chevron-left"></i> java学习书籍推荐</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/java-reference/" rel="prev" title="java引用类型">java引用类型 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC80NDc5OS8yMTMyMA=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="//cloud.ovvow.com/static/images/avatar.jpg" alt="何处有所栖"><p class="site-author-name" itemprop="name">何处有所栖</p><div class="site-description motion-element" itemprop="description">想到什么写点什么，偶尔中二，偶尔哲学。</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">17</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">12</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/guopengd" title="GitHub &rarr; https://github.com/guopengd" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:648276765@gmail.com" title="E-Mail &rarr; mailto:648276765@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://www.xuboke.cn" title="http://www.xuboke.cn" rel="noopener" target="_blank">xuboke</a></li><li class="links-of-blogroll-item"><a href="https://asdfv1929.github.io" title="https://asdfv1929.github.io" rel="noopener" target="_blank">asdfv1929</a></li><li class="links-of-blogroll-item"><a href="https://www.cnblogs.com/Tu9oh0st" title="https://www.cnblogs.com/Tu9oh0st" rel="noopener" target="_blank">蔡总</a></li><li class="links-of-blogroll-item"><a href="https://yexua.github.io" title="https://yexua.github.io" rel="noopener" target="_blank">歌也听歌</a></li><li class="links-of-blogroll-item"><a href="https://www.cnblogs.com/hanyuhuang" title="https://www.cnblogs.com/hanyuhuang" rel="noopener" target="_blank">奶子哥</a></li><li class="links-of-blogroll-item"><a href="http://www.echodemo.cc" title="http://www.echodemo.cc" rel="noopener" target="_blank">有才的班长</a></li><li class="links-of-blogroll-item"><a href="https://www.cnblogs.com/fromzore" title="https://www.cnblogs.com/fromzore" rel="noopener" target="_blank">fromzore</a></li><li class="links-of-blogroll-item"><a href="https://blog51461.club/" title="https://blog51461.club/" rel="noopener" target="_blank">ボ</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-前言"><span class="nav-number">1.</span> <span class="nav-text">1. 前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-java虚拟机运行时数据库"><span class="nav-number">2.</span> <span class="nav-text">2. java虚拟机运行时数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-程序计数器"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 程序计数器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-java虚拟机栈"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 java虚拟机栈</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-java堆"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 java堆</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-方法区"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 方法区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-运行时常量池"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 运行时常量池</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-直接内存"><span class="nav-number">2.6.</span> <span class="nav-text">2.6 直接内存</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-有关字符串的补充"><span class="nav-number">3.</span> <span class="nav-text">3. 有关字符串的补充</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-String对象的创建："><span class="nav-number">3.1.</span> <span class="nav-text">3.1 String对象的创建：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-String-intern"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 String.intern()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-有关字符串相加编译器的优化"><span class="nav-number">3.3.</span> <span class="nav-text">3.2 有关字符串相加编译器的优化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-来点哲学？"><span class="nav-number">4.</span> <span class="nav-text">4 来点哲学？</span></a></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">何处有所栖</span> <span>&nbsp;<a href="http://www.miitbeian.gov.cn/" target="_blank" style="color:red">赣ICP备19001925号</a></span></div><div class="theme-info"><div style="float:left">本网站由-</div><a rel="external nofollow" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank"><img style="float:left" src="https://cloud.ovvow.com/static/images/又拍云logo.png" width="70px"></a><div style="float:left">-提供CDN加速服务</div></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="//cloud.ovvow.com/static/js/canvas-nest/canvas-nest.min.js"></script><script src="//cloud.ovvow.com/static/js/jquery/index.js"></script><script src="//cloud.ovvow.com/static/js/jquery_lazyload/jquery.lazyload.js"></script><script src="//cloud.ovvow.com/static/js/velocity/velocity.js"></script><script src="//cloud.ovvow.com/static/js/velocity/velocity.ui.js"></script><script src="//cloud.ovvow.com/static/js/fancybox/source/jquery.fancybox.min.js"></script><script src="/js/utils.js?v=7.2.0"></script><script src="/js/motion.js?v=7.2.0"></script><script src="/js/affix.js?v=7.2.0"></script><script src="/js/schemes/pisces.js?v=7.2.0"></script><script src="/js/scrollspy.js?v=7.2.0"></script><script src="/js/post-details.js?v=7.2.0"></script><script src="/js/next-boot.js?v=7.2.0"></script><script>window.livereOptions={refer:"posts/java-virtual-machine-one/"},function(e,t){var n=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((t=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",t.async=!0,n.parentNode.insertBefore(t,n))}(document,"script")</script><script>var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")};function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var searchFunc=function(t,e,s){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(e),r=document.getElementById(s),t=function(){var m=n.value.trim().toLowerCase(),x=m.split(/[\s\-]+/);1<x.length&&x.push(m);var e,w=[];0<m.length&&o.forEach(function(t){var e=!1,o=0,h=0,n=t.title.trim(),r=n.toLowerCase(),s=t.content.trim().replace(/<[^>]+>/g,""),a=s.toLowerCase(),i=decodeURIComponent(t.url).replace(/\/{2,}/g,"/"),c=[],l=[];if(""!=n&&(x.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r,s=0,a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(r=e.indexOf(t,s));)a.push({position:r,word:t}),s=r+n;return a}c=c.concat(e(t,r,!1)),l=l.concat(e(t,a,!1))}),(0<c.length||0<l.length)&&(e=!0,o=c.length+l.length)),e){function p(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===m&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}[c,l].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});t=[];0!=c.length&&t.push(p(0,0,n.length,c));for(var u=[];0!=l.length;){var f=l[l.length-1],d=f.position,g=f.word,v=d-20,f=d+80;v<0&&(v=0),f<d+g.length&&(f=d+g.length),f>s.length&&(f=s.length),u.push(p(0,v,f,l))}u.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});e=parseInt("1");function $(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}0<=e&&(u=u.slice(0,e));var C="";0!=t.length?C+="<li><a href='"+i+"' class='search-result-title'>"+$(n,t[0])+"</a>":C+="<li><a href='"+i+"' class='search-result-title'>"+n+"</a>",u.forEach(function(t){C+="<a href='"+i+'\'><p class="search-result">'+$(s,t)+"...</p></a>"}),C+="</li>",w.push({item:C,searchTextCount:h,hitCount:o,id:w.length})}}),1===x.length&&""===x[0]?r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>':0===w.length?r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>':(w.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id}),e='<ul class="search-result-list">',w.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e)};n.addEventListener("input",t),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script>$(".highlight").not(".gist .highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea"),o=window.pageYOffset||document.documentElement.scrollTop;n.style.top=o+"px",n.style.position="absolute",n.style.opacity="0",n.readOnly=!0,n.value=e,document.body.appendChild(n);const a=document.getSelection();o=0<a.rangeCount&&a.getRangeAt(0);n.select(),n.setSelectionRange(0,e.length),n.readOnly=!1,document.execCommand("copy")?$(this).text("复制成功"):$(this).text("复制失败"),n.blur(),$(this).blur(),o&&(a.removeAllRanges(),a.addRange(o))})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script src="/live2dw/js/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"js/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/koharu.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!1},react:{opacity:.7},log:!1})</script></body></html><script type="text/javascript" src="/js/crash_cheat.js"></script>